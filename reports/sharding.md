# Домашнее задание: Шардирование в PostgreSQL с использованием Citus

## Выполненные шаги

### 1. Создание микросервиса для работы с сообщениями

Разработан микросервис, предоставляющий API для работы с сообщениями.  
Для тестирования микросервиса подготовлена коллекция запросов в директории `postman`.

Доступные эндпоинты:
- **`POST /api/chats/{chat_id}/send-message`**: отправка сообщения в указанный чат.
- **`GET /api/chats/{chat_id}/list-messages`**: получение списка сообщений из указанного чата.

---

### 2. Настройка шардирования

Шардирование реализовано с использованием **Citus**.  
По умолчанию используются два узла. Основной объект шардирования — таблица `messages`.

#### Особенности реализации:
- **Шардирование происходит на основе поля `chat_id`**:  
  Это позволяет равномерно распределять данные по шардам.

- **Таблицы, не подлежащие шардированию**:
    - `chats`
    - `chat_users`  
      Эти таблицы небольшие и не требуют шардирования, так как их размер минимален и нагрузка на них невелика.

- **Распределение данных**:  
  Учитывается "эффект Леди Гаги", когда один пользователь может генерировать значительное количество сообщений. Предполагается, что такие пользователи активно участвуют в разных чатах, что не создает нагрузки на один шард.

#### Описание API и шардирования:
- API предоставляет возможность получения сообщений по конкретному идентификатору чата.
    - **Шардирование на основе временных меток не требуется**, так как запросы на получение последних сообщений из всех чатов не реализованы.

---

### 3. Добавление нового узла и перебалансировка данных

Для демонстрации работы с шардированием была воспроизведена ситуация с добавлением нового узла в кластер и последующей перебалансировкой данных.

#### Выполненные действия:
1. Добавлен новый узел в кластер.
2. Запущен блок `resharding` из `makefile`.

#### Особенности перебалансировки:
- При выполнении команды `resharding` данные перераспределяются между узлами.
- **Доступность данных**:  
  Во время перераспределения данные остаются доступными для чтения и записи.

---

## Заключение

- Настроено шардирование таблицы `messages` на основе `chat_id`, обеспечивающее равномерное распределение данных.
- Выполнено добавление нового узла и перебалансировка данных без нарушения доступности сервиса.
- API успешно протестировано, и его работа соответствует поставленным требованиям.